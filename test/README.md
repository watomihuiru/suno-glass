# Тесты для Suno AI Music Generator

Этот проект содержит комплексные тесты для проверки как фронтенда, так и бэкенда приложения.

## Структура тестов

```
test/
├── backend/              # Тесты для бэкенда
│   ├── api-request-service.test.js
│   ├── socket-handlers.test.js
│   ├── polling-service.test.js
│   └── server.test.js
└── frontend/            # Тесты для фронтенда
    ├── validation.test.js
    ├── utils.test.js
    └── setup.js
```

## Установка зависимостей

```bash
npm install
```

## Запуск тестов

### Все тесты
```bash
npm test
```

### Только тесты бэкенда
```bash
npm run test:backend
```

### Только тесты фронтенда
```bash
npm run test:frontend
```

### Тесты в режиме наблюдения (watch mode)
```bash
npm run test:watch
```

### Тесты с покрытием кода
```bash
npm run test:coverage
```

## Описание тестов

### Бэкенд тесты

#### `api-request-service.test.js`
Тестирует сервис для работы с API запросами:
- Успешные API запросы
- Обработка ошибок (HTTP и API-level)
- Логика повторных попыток (retry)
- Получение статуса задачи
- Получение кредитов
- Получение URL для загрузки файлов

#### `socket-handlers.test.js`
Тестирует обработчики Socket.IO событий:
- Обработка подключений
- Генерация музыки (generate_music)
- Создание кавера (generate_cover)
- Расширение трека (generate_extend)
- Получение кредитов
- Получение URL для загрузки
- Ограничение частоты запросов (rate limiting)
- Обработка ошибок

#### `polling-service.test.js`
Тестирует сервис опроса статуса задач:
- Запуск опроса
- Обработка различных статусов (SUCCESS, FAILED, PROCESSING)
- Таймауты опроса
- Обработка ошибок при опросе
- Очистка опросов
- Статистика опросов

#### `server.test.js`
Интеграционные тесты сервера:
- Раздача статических файлов
- Socket.IO подключения
- Парсинг JSON запросов

### Фронтенд тесты

#### `validation.test.js`
Тестирует утилиты валидации форм:
- Валидация простого режима
- Валидация кастомного режима
- Валидация формы расширения (extend)
- Валидация аудио файлов
- Построение API payload
- Проверка лимитов длины полей

#### `utils.test.js`
Тестирует вспомогательные функции:
- Форматирование названий моделей
- Форматирование времени

## Настройка окружения

Для работы тестов необходимо установить переменные окружения (опционально, используются моки):

```bash
SUNO_BASE_URL=https://api.example.com
SUNO_API_KEY=test-api-key
PORT=3000
```

## Покрытие кода

После запуска `npm run test:coverage` будет сгенерирован отчет о покрытии кода в папке `coverage/`.

## Примечания

- Тесты используют моки для внешних зависимостей (API, Socket.IO)
- Фронтенд тесты используют jsdom для эмуляции браузерного окружения
- Некоторые интеграционные тесты могут требовать запущенного сервера

## Добавление новых тестов

При добавлении новых функций:

1. Создайте соответствующий тестовый файл в `test/backend/` или `test/frontend/`
2. Следуйте существующим паттернам именования: `*.test.js`
3. Используйте описательные имена тестов
4. Группируйте связанные тесты с помощью `describe()`
5. Используйте моки для внешних зависимостей

## Troubleshooting

### Ошибки с jsdom
Если возникают проблемы с jsdom для фронтенд тестов, убедитесь что установлена последняя версия:
```bash
npm install --save-dev jsdom@latest
```

### Проблемы с Socket.IO тестами
Некоторые Socket.IO тесты могут требовать запущенного сервера. В этом случае они будут пропущены автоматически.




